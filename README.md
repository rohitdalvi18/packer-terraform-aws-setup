# packer-terraform-aws-setup

## Overview
This project automates infrastructure provisioning using **Packer** and **Terraform**. It includes:
- **Packer**: Creates a custom Amazon Machine Image (AMI) with Docker and SSH access.
- **Terraform**: Provisions a secure AWS environment with a **VPC, Bastion Host, and Private EC2 Instances**.
- **Security Best Practices**: Bastion host for SSH access, private EC2 instances with no public IPs.

---

## Project Structure
```
.
â”œâ”€â”€ packer/
â”‚   â”œâ”€â”€ amazon-linux.pkr.hcl        # Packer template to build custom AMI
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ versions.tf                 # Terraform version and provider details
â”‚   â”œâ”€â”€ variables.tf                # Variables for Terraform setup
â”‚   â”œâ”€â”€ vpc.tf                      # VPC setup
â”‚   â”œâ”€â”€ bastion_host.tf             # Bastion host setup
â”‚   â”œâ”€â”€ private_ec2_instances.tf    # Private EC2 instances setup
â”‚   â”œâ”€â”€ outputs.tf                  # Terraform outputs
â”‚   â”œâ”€â”€ providers.tf                # AWS provider configuration
â”‚   â”œâ”€â”€ terraform.tfvars            # User-defined secret values (ignored in Git)
â”‚   â”œâ”€â”€ README.md                   # Documentation
â””â”€â”€ .gitignore                      # Ignore sensitive files
â””â”€â”€ .labsuser.pem                   # Your AWS lab key (ignored in Git)
â””â”€â”€ .keypair.pem                    # Your private EC2 SSH key (ignored in Git)
```

---

## Prerequisites
Ensure you have the following installed:
- **Terraform** (>= 1.3.0)
- **Packer** (latest version)
- **AWS CLI** (configured with appropriate credentials)
- **SSH Key Pair** for Bastion Host and private EC2 instances

---

## Build Custom AMI with Packer

1. Navigate to the **Packer** directory:
   ```sh
   cd packer/
   ```
2. Initialize and Format your Packer configuration
   ```sh
   packer init .
   packer fmt .
   ```
3. Validate the Packer template:
   ```sh
   packer validate .
   ```
3. Build the custom AMI:
   ```sh
   packer build amazon-linux.pkr.hcl
   ```
### Output

1. You should see below output in terminal:

   <img width="720" alt="terminal1" src="https://github.com/user-attachments/assets/d7f81259-4351-498c-96e3-74c9b3ad75ab" />
   <img width="720" alt="terminal2" src="https://github.com/user-attachments/assets/58528ee1-f8e1-4fa8-9d9f-db1508943877" />
   <img width="720" alt="terminal3" src="https://github.com/user-attachments/assets/e168b4e3-16da-4737-bbb7-53e74b17967b" />


2. A temporary keypair is generated by Packer:

    <img width="720" alt="keypair" src="https://github.com/user-attachments/assets/779e2721-954b-4b40-831c-414b0a9bee92" />


3. A temporary EC2 instance is launched by Packer to create the AMI:

    <img width="720" alt="ec2" src="https://github.com/user-attachments/assets/4a04808d-163c-4328-bf11-557a33071850" />


4. Note the **AMI ID** from the output for use in Terraform:

    <img width="720" alt="AMI" src="https://github.com/user-attachments/assets/d1c5dff5-f748-47c5-abaa-80b7e28bf3b1" />


---

## Deploy Infrastructure with Terraform

1. Navigate to the **Terraform** directory:
   ```sh
   cd terraform/
   ```
2. Create a new file  `terraform.tfvars`  with below secrets:
   ```sh
    bastion_allowed_ip = "YOUR_IP/32"
    vpc_public_subnet           = "VPC_ID"
    custom_image_id             = "YOUR_CUSTOM_AMI_ID"
    bastion_key_pair            = "vockey_OR_deafult_SSH_KEY"
    private_instance_key        = "vockey_OR_PRIVATE_EC2_KEY" 
   ```
3. Initialize Terraform:
   ```sh
   terraform init
   ```
4. Validate the Terraform configuration:
   ```sh
   terraform validate
   ```
5. Apply the changes to provision resources:
   ```sh
   terraform apply -var-file=terraform.tfvars
   ```

### Output
After deployment, Terraform provides:
- **VPC ID**
    <img width="720" alt="vpc" src="https://github.com/user-attachments/assets/e76cbd69-b15d-4251-897c-320d56bbb81c" />

- **Public Subnets & Private Subnets IDs**
    <img width="720" alt="subnet" src="https://github.com/user-attachments/assets/a8510c88-46b7-45eb-917b-ab7604427995" />

- **Bastion Host Public IP**
    <img width="720" alt="bastain host" src="https://github.com/user-attachments/assets/950c7ac0-5c2a-4aab-a06f-cba083ca1e2f" />

- **Private EC2 Instance Details**
    <img width="720" alt="priavte ec2s and bastian host" src="https://github.com/user-attachments/assets/e342f584-46d4-485c-92c7-ecdba4e4d6ef" />

---

## SSH Access
- **Bastion Host:** Connect using your SSH key:
  ```sh
  ssh -A -i <your-bastion-key>.pem ec2-user@<bastion-public-ip>
  ```
- **Private EC2:** From the Bastion Host, use:
  ```sh
  ssh -i <your-private-key>.pem ec2-user@<private-ec2-ip>
  ```

### Output

    <img width="720" alt="ssh" src="https://github.com/user-attachments/assets/b3f8e8cc-212d-44e6-8340-1caca81c140e" />

---

## Cleanup
To destroy all resources, run:
```sh
terraform destroy 
```
---

## Conclusion

This demonstrates the automated provisioning of AWS infrastructure using Packer for creating a custom AMI and Terraform for deploying a secure, scalable architecture. By integrating a bastion host, private EC2 instances, and modular Terraform configurations, the setup ensures a structured and efficient deployment process. With this approach, infrastructure can be easily managed, replicated, and scaled while maintaining security best practices. ðŸš€

